<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Pro v8.7 - iOS Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .card { background: #1e293b; border-radius: 1.5rem; border: 1px solid #334155; }
        .input-pro { background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; border-radius: 0.75rem; width: 100%; font-size: 16px; }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 12px; color: #64748b; }
        .nav-btn.active { color: #3b82f6; border-bottom: 3px solid #3b82f6; }
        .sticky-header { position: sticky; top: 0; z-index: 100; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid #1e293b; }
        #month-modal { background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }

        .switch { position: relative; display: inline-block; min-width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body class="pb-28">

    <header class="sticky-header p-5">
        <div class="max-w-md mx-auto flex justify-between items-end">
            <div>
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-1">Tiszta pénzed</p>
                <h1 id="top-final-money" class="text-3xl font-extrabold text-white">0 Ft</h1>
            </div>
            <div class="text-right">
                <p class="text-[10px] font-black text-emerald-500 uppercase tracking-widest mb-1">Ma költhető</p>
                <div id="top-daily-limit" class="text-xl font-bold text-emerald-400 font-mono">0 Ft</div>
            </div>
        </div>
    </header>

    <main class="p-4 max-w-md mx-auto space-y-6">
        <div id="view-main" class="space-y-6">
            <section class="card p-5">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2 space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 ml-1 italic">Fizetés + Meglévő</label>
                        <input type="tel" id="val-salary" oninput="formatInput(this); calculate()" class="input-pro text-xl font-bold text-blue-400" placeholder="Írj ide összeget">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 ml-1 italic">Készpénz</label>
                        <input type="tel" id="val-cash" oninput="formatInput(this); calculate()" class="input-pro" placeholder="0 Ft">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 ml-1 italic">Célösszeg</label>
                        <input type="tel" id="val-target" oninput="formatInput(this); calculate()" class="input-pro" placeholder="Írj ide összeget">
                    </div>
                </div>
            </section>
            
            <section class="card p-5 bg-slate-800/50">
                <div class="flex justify-between items-center text-sm mb-3">
                    <span class="text-slate-400 font-bold uppercase text-[10px]">Fizetés napja: <span id="display-days-left" class="text-blue-300 ml-2 font-mono">0 NAP</span></span>
                    <input type="number" inputmode="numeric" id="val-payday" oninput="calculate()" class="w-12 bg-slate-950 text-center rounded text-white py-2 border border-slate-700" value="10">
                </div>
                <div class="flex justify-between items-center pt-3 border-t border-slate-700">
                    <span class="text-[10px] font-black text-red-400 uppercase tracking-tighter">Még fizetendő fixek:</span>
                    <span id="display-fixed-sum" class="text-sm font-bold text-red-500">0 Ft</span>
                </div>
            </section>

            <section class="card p-5 border-l-4 border-red-500">
                <div id="list-expenses" class="space-y-2 mb-4"></div>
                <button onclick="addExpense()" class="w-full py-3 border-2 border-dashed border-slate-700 rounded-xl text-slate-500 text-[10px] font-bold uppercase">+ Új számla</button>
            </section>
        </div>

        <div id="view-mom" class="hidden space-y-6">
            <section class="card p-5 border-t-4 border-orange-500">
                <div class="grid grid-cols-4 gap-3 mb-6">
                    <button onclick="showMonthPicker()" class="col-span-3 py-4 bg-blue-600 rounded-xl font-bold text-white shadow-lg flex items-center justify-center gap-2 text-sm active:scale-95 transition">
                        <i class="fas fa-file-pdf text-xl"></i> PDF MEGOSZTÁSA
                    </button>
                    <button onclick="clearAllRefunds()" class="col-span-1 py-4 bg-red-900/30 border border-red-800 rounded-xl font-bold text-red-400 flex items-center justify-center hover:bg-red-900 active:scale-95 transition" title="Minden törlése">
                        <i class="fas fa-trash-can text-lg"></i>
                    </button>
                </div>

                <div class="flex justify-between items-center mb-6 px-1">
                    <h2 class="text-lg font-bold italic text-orange-400">Anyu Keret</h2>
                    <input type="tel" id="val-mom-base" oninput="formatInput(this); calculate()" class="w-32 bg-transparent border-b border-orange-500 text-right font-black text-orange-400 text-xl focus:outline-none" placeholder="Írj ide">
                </div>

                <div class="flex justify-between items-center bg-slate-900/80 p-4 rounded-xl border border-slate-800 mb-6 shadow-inner">
                    <div class="flex flex-col">
                        <span class="text-[9px] text-slate-500 uppercase font-black tracking-wider">Még hátra</span>
                        <span id="display-mom-final" class="text-lg font-bold text-orange-500">0 Ft</span>
                    </div>
                    <div class="text-right flex flex-col">
                        <span class="text-[9px] text-slate-500 uppercase font-black tracking-wider">Eddig költött</span>
                        <span id="display-refund-sum" class="text-lg font-bold text-emerald-500">0 Ft</span>
                    </div>
                </div>
                
                <div class="bg-emerald-500/5 p-4 rounded-2xl border border-emerald-500/20 mb-6">
                    <label class="text-[10px] text-emerald-600 font-bold uppercase mb-2 block ml-1">Gyors hozzáadás</label>
                    <div class="flex gap-2">
                        <input type="tel" id="input-quick" oninput="formatInput(this)" onchange="quickAdd()" onkeydown="if(event.key === 'Enter') quickAdd()" class="input-pro border-emerald-500/40 text-emerald-400 text-center text-xl font-bold" placeholder="Összeg...">
                        <button onclick="quickAdd()" class="bg-emerald-600 px-6 rounded-xl text-white shadow-lg active:scale-95 transition"><i class="fas fa-plus text-xl"></i></button>
                    </div>
                </div>

                <div id="list-mom-refunds" class="space-y-1 divide-y divide-slate-800"></div>
            </section>
        </div>
    </main>

    <button onclick="window.location.reload()" class="fixed bottom-24 right-5 z-40 bg-slate-800 text-white w-12 h-12 rounded-full border border-slate-600 shadow-xl flex items-center justify-center hover:bg-slate-700 transition-all active:scale-95">
        <i class="fas fa-sync-alt"></i>
    </button>
    
    <div id="loading-overlay" class="fixed inset-0 z-[250] hidden bg-black/80 flex flex-col items-center justify-center backdrop-blur-sm">
        <i class="fas fa-circle-notch fa-spin text-4xl text-blue-500 mb-3"></i>
        <span class="text-white font-bold">PDF Generálása...</span>
    </div>

    <div id="month-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-white text-center">Melyik hónapot küldöd?</h3>
            <div id="month-options" class="space-y-2 max-h-60 overflow-y-auto mb-6"></div>
            <button onclick="closeMonthPicker()" class="w-full py-3 text-slate-400 font-bold border border-slate-700 rounded-xl hover:bg-slate-800">Mégse</button>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 h-20 bg-slate-950 border-t border-slate-800 flex z-50">
        <button onclick="setTab('main')" id="nav-main" class="nav-btn active">
            <i class="fas fa-wallet text-xl mb-1"></i><span class="text-[9px] font-bold uppercase">Pénzügyek</span>
        </button>
        <button onclick="setTab('mom')" id="nav-mom" class="nav-btn">
            <i class="fas fa-hand-holding-heart text-xl mb-1"></i><span class="text-[9px] font-bold uppercase">Anyu</span>
        </button>
    </nav>

    <script>
        let db = JSON.parse(localStorage.getItem('fin_v8_final')) || {
            salary: 0, cash: 0, target: 0, payday: 10, momBase: 0,
            expenses: [], refunds: []
        };

        async function loadFont() {
            const response = await fetch('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf');
            const buffer = await response.arrayBuffer();
            return buffer;
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        function formatInput(el) {
            let cursor = el.selectionStart;
            let val = el.value.replace(/\D/g, '');
            if (val === "") { el.value = ""; return; }
            el.value = Number(val).toLocaleString('hu-HU') + ' Ft';
            // Megpróbáljuk visszaállítani a kurzort, de mobilon néha a végére ugrik, ami nem baj számoknál
            try { el.setSelectionRange(cursor, cursor); } catch(e){}
        }

        function getNum(id) {
            const el = document.getElementById(id);
            return el ? (Number(el.value.replace(/\D/g, '')) || 0) : 0;
        }

        function quickAdd() {
            const el = document.getElementById('input-quick');
            const v = getNum('input-quick');
            // Csak akkor adjuk hozzá, ha van érték (elkerüli a véletlen blur eseményeket)
            if(v > 0) {
                const d = new Date();
                db.refunds.unshift({
                    id: Date.now(), 
                    v: v, 
                    dateStr: d.toLocaleDateString('hu-HU'),
                    monthKey: d.getFullYear() + ". " + d.toLocaleString('hu-HU', { month: 'long' }),
                    time: d.toLocaleTimeString('hu-HU',{hour:'2-digit', minute:'2-digit'})
                });
                el.value = '';
                // el.focus(); // iOS-en ezt kivettük, hogy a billentyűzet eltűnjön sikeres bevitel után (tisztább érzés)
                render();
            }
        }

        function clearAllRefunds() {
            if(confirm("BIZTOSAN TÖRLÖD az összes eddigi visszafizetés tételt?\nEzt nem lehet visszavonni!")) {
                db.refunds = [];
                render();
                calculate();
            }
        }

        function showMonthPicker() {
            const months = [...new Set(db.refunds.map(r => r.monthKey))];
            const container = document.getElementById('month-options');
            container.innerHTML = '';
            if(months.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-center py-4 text-sm italic">Nincs rögzített költés.</p>';
            } else {
                months.forEach(m => {
                    const btn = document.createElement('button');
                    btn.className = "w-full py-4 bg-slate-800 rounded-xl font-bold text-blue-400 border border-slate-700 mb-2 hover:bg-slate-700 transition";
                    btn.innerText = m;
                    btn.onclick = () => { generateAndSharePDF(m); closeMonthPicker(); };
                    container.appendChild(btn);
                });
            }
            document.getElementById('month-modal').classList.remove('hidden');
        }

        function closeMonthPicker() { document.getElementById('month-modal').classList.add('hidden'); }

        async function generateAndSharePDF(selectedMonth) {
            document.getElementById('loading-overlay').classList.remove('hidden'); 
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                try {
                    const fontBuffer = await loadFont();
                    const fontBase64 = arrayBufferToBase64(fontBuffer);
                    doc.addFileToVFS("Roboto-Regular.ttf", fontBase64);
                    doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
                    doc.setFont("Roboto"); 
                } catch (e) {
                    console.warn("Font betöltési hiba.", e);
                }

                const filteredData = db.refunds.filter(r => r.monthKey === selectedMonth);
                
                const dailyTotals = {};
                filteredData.forEach(item => {
                    if(!dailyTotals[item.dateStr]) {
                        dailyTotals[item.dateStr] = 0;
                    }
                    dailyTotals[item.dateStr] += item.v;
                });

                const aggregatedData = Object.keys(dailyTotals).sort().reverse().map(date => {
                    return { dateStr: date, v: dailyTotals[date] };
                });

                const totalRefunded = filteredData.reduce((s, i) => s + i.v, 0);
                const remaining = Math.max(0, db.momBase - totalRefunded);
                
                doc.setFontSize(36);
                doc.setTextColor(30, 58, 138);
                doc.text("HAVI ELSZÁMOLÁS", 105, 30, { align: 'center' }); 
                
                doc.setFontSize(16);
                doc.setTextColor(100, 116, 139);
                doc.text(`IDŐSZAK: ${selectedMonth.toUpperCase()}`, 105, 42, { align: 'center' });
                
                doc.setFillColor(241, 245, 249);
                doc.roundedRect(15, 50, 180, 60, 3, 3, 'F');
                doc.setDrawColor(203, 213, 225);
                doc.roundedRect(15, 50, 180, 60, 3, 3, 'S');

                let yPos = 65;
                const lineHeight = 14;

                doc.setFontSize(16);
                doc.setTextColor(71, 85, 105);
                doc.text("Alapkeret:", 25, yPos);
                doc.setFontSize(18);
                doc.setTextColor(15, 23, 42);
                doc.setFont(undefined, 'bold');
                doc.text(`${db.momBase.toLocaleString('hu-HU')} Ft`, 185, yPos, { align: 'right' });
                doc.setFont(undefined, 'normal');

                yPos += lineHeight;
                doc.setFontSize(16);
                doc.setTextColor(71, 85, 105);
                doc.text("Eddig költött:", 25, yPos);
                doc.setFontSize(18); 
                doc.setTextColor(37, 99, 235);
                doc.setFont(undefined, 'bold');
                doc.text(`${totalRefunded.toLocaleString('hu-HU')} Ft`, 185, yPos, { align: 'right' });
                doc.setFont(undefined, 'normal');

                yPos += lineHeight;
                doc.setFontSize(18); 
                doc.setTextColor(71, 85, 105);
                doc.text("Fennmaradó:", 25, yPos);
                doc.setFontSize(22);
                doc.setTextColor(217, 119, 6);
                doc.setFont(undefined, 'bold');
                doc.text(`${remaining.toLocaleString('hu-HU')} Ft`, 185, yPos, { align: 'right' });

                const tableData = aggregatedData.map(r => [r.dateStr, r.v.toLocaleString('hu-HU') + " Ft"]);
                
                doc.autoTable({
                    startY: 125,
                    head: [['Dátum', 'Napi összesen']],
                    body: tableData,
                    theme: 'striped',
                    styles: { 
                        font: "Roboto", 
                        fontSize: 14, 
                        cellPadding: 8,
                        valign: 'middle',
                        textColor: [30, 41, 59]
                    },
                    headStyles: { 
                        fillColor: [30, 58, 138],
                        textColor: [255, 255, 255],
                        fontSize: 14, 
                        halign: 'left',
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        0: { cellWidth: 100, halign: 'left' }, 
                        1: { cellWidth: 'auto', halign: 'right', fontStyle: 'bold', textColor: [37, 99, 235] }
                    },
                    margin: { left: 15, right: 15 }
                });

                doc.setFontSize(10);
                doc.setTextColor(150, 150, 150);
                doc.text("Finance Pro - Automatikus elszámolás", 105, 290, { align: 'center' });

                const pdfOutput = doc.output('blob');
                const fileName = `elszamolas_${selectedMonth.replace(/\s/g, '').replace(/\./g,'')}.pdf`;
                const file = new File([pdfOutput], fileName, { type: 'application/pdf' });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'Finance Elszámolás',
                        text: `${selectedMonth} havi elszámolás`
                    });
                } else {
                    doc.save(fileName);
                }

            } catch (err) {
                alert("Hiba a PDF generáláskor: " + err.message);
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        function calculate() {
            db.salary = getNum('val-salary');
            db.cash = getNum('val-cash');
            db.target = getNum('val-target');
            db.payday = Number(document.getElementById('val-payday').value) || 10;
            db.momBase = getNum('val-mom-base');

            db.expenses.forEach(ex => {
                const nameEl = document.getElementById(`ex-n-${ex.id}`);
                const valEl = document.getElementById(`ex-v-${ex.id}`);
                const paidEl = document.getElementById(`ex-p-${ex.id}`);
                if(nameEl) ex.n = nameEl.value;
                if(valEl) ex.v = Number(valEl.value.replace(/\D/g, '')) || 0;
                if(paidEl) ex.paid = paidEl.checked;
            });

            const now = new Date();
            let targetDate = new Date(now.getFullYear(), now.getMonth(), db.payday);
            if(now.getDate() >= db.payday) targetDate = new Date(now.getFullYear(), now.getMonth()+1, db.payday);
            const daysLeft = Math.max(1, Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24)));

            const totalWealth = db.salary + db.cash; 
            const totalRefunds = db.refunds.reduce((s,i) => s + i.v, 0); 
            const momFinal = Math.max(0, db.momBase - totalRefunds); 
            const unpaidFixedSum = db.expenses.reduce((s,i) => s + (i.paid ? 0 : i.v), 0) + momFinal; 
            const finalCleanMoney = totalWealth - unpaidFixedSum;
            
            const diffFromTarget = finalCleanMoney - db.target;
            const daily = diffFromTarget > 0 ? Math.floor(diffFromTarget / daysLeft) : 0;

            document.getElementById('top-final-money').innerText = finalCleanMoney.toLocaleString('hu-HU') + ' Ft';
            document.getElementById('top-daily-limit').innerText = daily.toLocaleString('hu-HU') + ' Ft';
            document.getElementById('display-days-left').innerText = daysLeft + " NAP";
            document.getElementById('display-fixed-sum').innerText = unpaidFixedSum.toLocaleString('hu-HU') + ' Ft';
            document.getElementById('display-mom-final').innerText = momFinal.toLocaleString('hu-HU') + " Ft";
            document.getElementById('display-refund-sum').innerText = totalRefunds.toLocaleString('hu-HU') + " Ft";
            
            localStorage.setItem('fin_v8_final', JSON.stringify(db));
        }

        function render() {
            document.getElementById('val-salary').value = db.salary > 0 ? db.salary.toLocaleString('hu-HU') + ' Ft' : '';
            document.getElementById('val-cash').value = db.cash > 0 ? db.cash.toLocaleString('hu-HU') + ' Ft' : '';
            document.getElementById('val-target').value = db.target > 0 ? db.target.toLocaleString('hu-HU') + ' Ft' : '';
            document.getElementById('val-mom-base').value = db.momBase > 0 ? db.momBase.toLocaleString('hu-HU') + ' Ft' : '';
            document.getElementById('val-payday').value = db.payday;

            const exCont = document.getElementById('list-expenses');
            exCont.innerHTML = db.expenses.map(ex => `
                <div class="flex gap-2 items-center bg-slate-900/40 p-2 rounded-xl border border-slate-800">
                    <label class="switch ml-1">
                        <input type="checkbox" id="ex-p-${ex.id}" ${ex.paid ? 'checked' : ''} onchange="calculate(); render()">
                        <span class="slider"></span>
                    </label>
                    <input type="text" enterkeyhint="next" id="ex-n-${ex.id}" value="${ex.n}" oninput="calculate()" class="input-pro text-xs py-2 border-none bg-transparent" placeholder="Név">
                    <input type="tel" id="ex-v-${ex.id}" value="${ex.v > 0 ? ex.v.toLocaleString('hu-HU') + ' Ft' : ''}" oninput="formatInput(this); calculate()" class="input-pro w-28 text-right py-2 font-bold border-none bg-transparent ${ex.paid ? 'text-slate-500' : 'text-red-500'}" placeholder="0 Ft">
                    <button onclick="remove(${ex.id}, 'expenses')" class="text-slate-600 px-2">✕</button>
                </div>
            `).join('');

            const refCont = document.getElementById('list-mom-refunds');
            const sortedRefunds = [...db.refunds].sort((a,b) => b.id - a.id);
            
            refCont.innerHTML = sortedRefunds.map(ref => `
                <div class="flex justify-between items-center py-4 border-slate-800">
                    <div class="flex flex-col"><span class="text-xs text-slate-400">${ref.dateStr}</span><span class="text-[10px] text-slate-600">${ref.time}</span></div>
                    <span class="text-emerald-400 font-black">+ ${ref.v.toLocaleString('hu-HU')} Ft</span>
                    <button onclick="remove(${ref.id}, 'refunds')" class="text-slate-700 text-xs px-3 font-bold uppercase hover:text-red-400">Töröl</button>
                </div>
            `).join('');
            calculate();
        }

        function setTab(t) {
            document.getElementById('view-main').classList.toggle('hidden', t !== 'main');
            document.getElementById('view-mom').classList.toggle('hidden', t !== 'mom');
            document.getElementById('nav-main').classList.toggle('active', t === 'main');
            document.getElementById('nav-mom').classList.toggle('active', t === 'mom');
        }

        function addExpense() { db.expenses.push({id: Date.now(), n: '', v: 0, paid: false}); render(); }
        
        function remove(id, type) { 
            if(confirm("Biztosan törölni szeretnéd ezt a tételt?")) {
                db[type] = db[type].filter(x => x.id !== id); 
                calculate(); 
                render(); 
            }
        }
        
        window.onload = render;
    </script>
</body>
</html>
