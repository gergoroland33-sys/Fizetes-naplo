<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Pro v8 - Final Summary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .card { background: #1e293b; border-radius: 1.5rem; border: 1px solid #334155; }
        .input-pro { background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; border-radius: 0.75rem; width: 100%; font-size: 16px; }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 12px; color: #64748b; }
        .nav-btn.active { color: #3b82f6; border-bottom: 3px solid #3b82f6; }
        .sticky-header { position: sticky; top: 0; z-index: 100; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid #1e293b; }
        #month-modal { background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="pb-28">

    <header class="sticky-header p-5">
        <div class="max-w-md mx-auto flex justify-between items-end">
            <div>
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-1">Tiszta pénzed</p>
                <h1 id="top-final-money" class="text-3xl font-extrabold text-white">0 Ft</h1>
            </div>
            <div class="text-right">
                <p class="text-[10px] font-black text-emerald-500 uppercase tracking-widest mb-1">Ma költhető</p>
                <div id="top-daily-limit" class="text-xl font-bold text-emerald-400 font-mono">0 Ft</div>
            </div>
        </div>
    </header>

    <main class="p-4 max-w-md mx-auto space-y-6">
        <div id="view-main" class="space-y-6">
            <section class="card p-5">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2 space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 ml-1 italic">Fizetés + Meglévő</label>
                        <input type="text" id="val-salary" oninput="formatInput(this); calculate()" class="input-pro text-xl font-bold text-blue-400" placeholder="Összeg">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 ml-1 italic">Készpénz</label>
                        <input type="text" id="val-cash" oninput="formatInput(this); calculate()" class="input-pro" placeholder="0 Ft">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 ml-1 italic">Célösszeg</label>
                        <input type="text" id="val-target" oninput="formatInput(this); calculate()" class="input-pro" placeholder="Összeg">
                    </div>
                </div>
            </section>
            
            <section class="card p-5 bg-slate-800/50">
                <div class="flex justify-between items-center text-sm mb-3">
                    <span class="text-slate-400 font-bold uppercase text-[10px]">Fizetés napja: <span id="display-days-left" class="text-blue-300 ml-2 font-mono">0 NAP</span></span>
                    <input type="number" id="val-payday" oninput="calculate()" class="w-12 bg-slate-950 text-center rounded text-white py-2 border border-slate-700" value="10">
                </div>
                <div class="flex justify-between items-center pt-3 border-t border-slate-700">
                    <span class="text-[10px] font-black text-red-400 uppercase tracking-tighter">Még fizetendő fixek:</span>
                    <span id="display-fixed-sum" class="text-sm font-bold text-red-500">0 Ft</span>
                </div>
            </section>

            <section class="card p-5 border-l-4 border-red-500">
                <div id="list-expenses" class="space-y-2 mb-4"></div>
                <button onclick="addExpense()" class="w-full py-3 border-2 border-dashed border-slate-700 rounded-xl text-slate-500 text-[10px] font-bold uppercase">+ Új számla</button>
            </section>
        </div>

        <div id="view-mom" class="hidden space-y-6">
            <section class="card p-5 border-t-4 border-orange-500">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold italic text-orange-400">Anyu Keret</h2>
                    <input type="text" id="val-mom-base" oninput="formatInput(this); calculate()" class="w-32 bg-transparent border-b border-orange-500 text-right font-black text-orange-400 text-xl focus:outline-none" placeholder="Összeg">
                </div>

                <div class="flex justify-between items-center bg-slate-900/80 p-3 rounded-xl border border-slate-800 mb-4 shadow-inner">
                    <div class="flex flex-col">
                        <span class="text-[9px] text-slate-500 uppercase font-black">Még hátra</span>
                        <span id="display-mom-final" class="text-sm font-bold text-orange-500">0 Ft</span>
                    </div>
                    <div class="text-right flex flex-col">
                        <span class="text-[9px] text-slate-500 uppercase font-black">Eddig vissza</span>
                        <span id="display-refund-sum" class="text-sm font-bold text-emerald-500">0 Ft</span>
                    </div>
                </div>
                
                <div class="bg-emerald-500/5 p-4 rounded-2xl border border-emerald-500/20 mb-6">
                    <div class="flex gap-2">
                        <input type="text" id="input-quick" oninput="formatInput(this)" onkeydown="if(event.key === 'Enter') quickAdd()" class="input-pro border-emerald-500/40 text-emerald-400 text-center text-xl font-bold" placeholder="Összeg Ft...">
                        <button onclick="quickAdd()" class="bg-emerald-600 px-6 rounded-xl text-white shadow-lg"><i class="fas fa-plus"></i></button>
                    </div>
                </div>

                <div id="list-mom-refunds" class="space-y-1 divide-y divide-slate-800"></div>

                <div class="mt-6">
                    <button onclick="showMonthPicker()" class="w-full py-4 bg-blue-600 rounded-2xl font-bold text-white shadow-lg flex items-center justify-center gap-2">
                        <i class="fas fa-file-pdf text-xl"></i> HAVI PDF GENERÁLÁSA
                    </button>
                </div>
            </section>
        </div>
    </main>

    <div id="month-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center p-6">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-white">Melyik hónapot küldöd?</h3>
            <div id="month-options" class="space-y-2 max-h-60 overflow-y-auto mb-6"></div>
            <button onclick="closeMonthPicker()" class="w-full py-3 text-slate-400 font-bold">Mégse</button>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 h-20 bg-slate-950 border-t border-slate-800 flex z-50">
        <button onclick="setTab('main')" id="nav-main" class="nav-btn active">
            <i class="fas fa-wallet text-xl mb-1"></i><span class="text-[9px] font-bold uppercase">Pénzügyek</span>
        </button>
        <button onclick="setTab('mom')" id="nav-mom" class="nav-btn">
            <i class="fas fa-hand-holding-heart text-xl mb-1"></i><span class="text-[9px] font-bold uppercase">Anyu</span>
        </button>
    </nav>

    <script>
        let db = JSON.parse(localStorage.getItem('fin_v8_final')) || {
            salary: 0, cash: 0, target: 0, payday: 10, momBase: 0,
            expenses: [], refunds: []
        };

        function formatInput(el) {
            let cursor = el.selectionStart;
            let val = el.value.replace(/\D/g, '');
            if (val === "") { el.value = ""; return; }
            el.value = Number(val).toLocaleString('hu-HU') + ' Ft';
            el.setSelectionRange(cursor, cursor); 
        }

        function getNum(id) {
            const el = document.getElementById(id);
            return el ? (Number(el.value.replace(/\D/g, '')) || 0) : 0;
        }

        function quickAdd() {
            const el = document.getElementById('input-quick');
            const v = getNum('input-quick');
            if(v > 0) {
                const d = new Date();
                db.refunds.unshift({
                    id: Date.now(), 
                    v: v, 
                    dateStr: d.toLocaleDateString('hu-HU'),
                    monthKey: d.getFullYear() + ". " + d.toLocaleString('hu-HU', { month: 'long' }),
                    time: d.toLocaleTimeString('hu-HU',{hour:'2-digit', minute:'2-digit'})
                });
                el.value = '';
                el.focus();
                render();
            }
        }

        function showMonthPicker() {
            const months = [...new Set(db.refunds.map(r => r.monthKey))];
            const container = document.getElementById('month-options');
            container.innerHTML = '';
            if(months.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-center py-4 text-sm italic">Nincs költés.</p>';
            } else {
                months.forEach(m => {
                    const btn = document.createElement('button');
                    btn.className = "w-full py-4 bg-slate-800 rounded-xl font-bold text-blue-400 border border-slate-700 mb-2";
                    btn.innerText = m;
                    btn.onclick = () => { generatePDF(m); closeMonthPicker(); };
                    container.appendChild(btn);
                });
            }
            document.getElementById('month-modal').classList.remove('hidden');
        }

        function closeMonthPicker() { document.getElementById('month-modal').classList.add('hidden'); }

        function generatePDF(selectedMonth) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const filteredData = db.refunds.filter(r => r.monthKey === selectedMonth);
            const totalRefunded = filteredData.reduce((s, i) => s + i.v, 0);
            const remaining = Math.max(0, db.momBase - totalRefunded);
            doc.setFontSize(22); doc.text("Költségelszámolás", 14, 20);
            doc.setFontSize(12); doc.text(`Időszak: ${selectedMonth}`, 14, 30);
            doc.text(`Anyu Keret: ${db.momBase.toLocaleString('hu-HU')} Ft`, 14, 45);
            doc.text(`Havi költés összesen: ${totalRefunded.toLocaleString('hu-HU')} Ft`, 14, 52);
            doc.setFont(undefined, 'bold'); doc.text(`Fennmaradó: ${remaining.toLocaleString('hu-HU')} Ft`, 14, 62);
            const tableData = filteredData.map(r => [r.dateStr + " " + r.time, r.v.toLocaleString('hu-HU') + " Ft"]);
            doc.autoTable({ startY: 70, head: [['Dátum', 'Összeg']], body: tableData, theme: 'grid' });
            doc.save(`elszamolas_${selectedMonth.replace(/\s/g, '')}.pdf`);
        }

        function calculate() {
            db.salary = getNum('val-salary');
            db.cash = getNum('val-cash');
            db.target = getNum('val-target');
            db.payday = Number(document.getElementById('val-payday').value) || 10;
            db.momBase = getNum('val-mom-base');

            db.expenses.forEach(ex => {
                const nameEl = document.getElementById(`ex-n-${ex.id}`);
                const valEl = document.getElementById(`ex-v-${ex.id}`);
                const paidEl = document.getElementById(`ex-p-${ex.id}`);
                if(nameEl) ex.n = nameEl.value;
                if(valEl) ex.v = Number(valEl.value.replace(/\D/g, '')) || 0;
                if(paidEl) ex.paid = paidEl.checked;
            });

            const now = new Date();
            let targetDate = new Date(now.getFullYear(), now.getMonth(), db.payday);
            if(now.getDate() >= db.payday) targetDate = new Date(now.getFullYear(), now.getMonth()+1, db.payday);
            const daysLeft = Math.max(1, Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24)));

            const totalWealth = db.salary + db.cash; 
            const totalRefunds = db.refunds.reduce((s,i) => s + i.v, 0); 
            const momFinal = Math.max(0, db.momBase - totalRefunds); 
            const unpaidFixedSum = db.expenses.reduce((s,i) => s + (i.paid ? 0 : i.v), 0) + momFinal; 
            const finalCleanMoney = totalWealth - unpaidFixedSum;
            
            const diffFromTarget = finalCleanMoney - db.target;
            const daily = diffFromTarget > 0 ? Math.floor(diffFromTarget / daysLeft) : 0;

            document.getElementById('top-final-money').innerText = finalCleanMoney.toLocaleString('hu-HU') + ' Ft';
            document.getElementById('top-daily-limit').innerText = daily.toLocaleString('hu-HU') + ' Ft';
            document.getElementById('display-days-left').innerText = daysLeft + " NAP";
            document.getElementById('display-fixed-sum').innerText = unpaidFixedSum.toLocaleString('hu-HU') + ' Ft';
            document.getElementById('display-mom-final').innerText = momFinal.toLocaleString('hu-HU') + " Ft";
            document.getElementById('display-refund-sum').innerText = totalRefunds.toLocaleString('hu-HU') + " Ft";
            
            localStorage.setItem('fin_v8_final', JSON.stringify(db));
        }

        function render() {
            document.getElementById('val-salary').value = db.salary > 0 ? db.salary.toLocaleString('hu-HU') + ' Ft' : '';
            document.getElementById('val-cash').value = db.cash > 0 ? db.cash.toLocaleString('hu-HU') + ' Ft' : '';
            document.getElementById('val-target').value = db.target > 0 ? db.target.toLocaleString('hu-HU') + ' Ft' : '';
            document.getElementById('val-mom-base').value = db.momBase > 0 ? db.momBase.toLocaleString('hu-HU') + ' Ft' : '';
            document.getElementById('val-payday').value = db.payday;

            const exCont = document.getElementById('list-expenses');
            exCont.innerHTML = db.expenses.map(ex => `
                <div class="flex gap-2 items-center bg-slate-900/40 p-2 rounded-xl border border-slate-800">
                    <input type="checkbox" id="ex-p-${ex.id}" ${ex.paid ? 'checked' : ''} onchange="calculate()" class="w-6 h-6 rounded border-slate-700 bg-slate-800">
                    <input type="text" id="ex-n-${ex.id}" value="${ex.n}" oninput="calculate()" class="input-pro text-xs py-2 border-none bg-transparent" placeholder="Név">
                    <input type="text" id="ex-v-${ex.id}" value="${ex.v > 0 ? ex.v.toLocaleString('hu-HU') + ' Ft' : ''}" oninput="formatInput(this); calculate()" class="input-pro w-28 text-right py-2 font-bold border-none bg-transparent" placeholder="0 Ft">
                    <button onclick="remove(${ex.id}, 'expenses')" class="text-slate-600 px-2">✕</button>
                </div>
            `).join('');

            const refCont = document.getElementById('list-mom-refunds');
            refCont.innerHTML = db.refunds.map(ref => `
                <div class="flex justify-between items-center py-4 border-slate-800">
                    <div class="flex flex-col"><span class="text-xs text-slate-400">${ref.dateStr}</span><span class="text-[10px] text-slate-600">${ref.time}</span></div>
                    <span class="text-emerald-400 font-black">+ ${ref.v.toLocaleString('hu-HU')} Ft</span>
                    <button onclick="remove(${ref.id}, 'refunds')" class="text-slate-700 text-xs px-3 font-bold">TÖRÖL</button>
                </div>
            `).join('');
            calculate();
        }

        function setTab(t) {
            document.getElementById('view-main').classList.toggle('hidden', t !== 'main');
            document.getElementById('view-mom').classList.toggle('hidden', t !== 'mom');
            document.getElementById('nav-main').classList.toggle('active', t === 'main');
            document.getElementById('nav-mom').classList.toggle('active', t === 'mom');
        }

        function addExpense() { db.expenses.push({id: Date.now(), n: '', v: 0, paid: false}); render(); }
        function remove(id, type) { db[type] = db[type].filter(x => x.id !== id); calculate(); render(); }
        window.onload = render;
    </script>
</body>
</html>
